# Story 4.2: Zentrale Mock-Pilot-Factory für Tests

**Epic:** Tests & Cleanup
**Aufwand:** S
**Priorität:** 2 (Sprint 2)
**Abhängigkeiten:** Story 4.1 sollte zuerst abgeschlossen sein (gemeinsamer helpers-Ordner)

## Beschreibung

Als Entwickler möchte ich eine zentrale Pilot-Factory für Tests, damit ich konsistente Mock-Piloten erstellen kann und Änderungen am Pilot-Interface nur an einer Stelle nachziehen muss.

## Akzeptanzkriterien

- [ ] AC1: Neue Datei `tests/helpers/mock-factories.ts` mit Pilot-Factory-Funktionen
- [ ] AC2: `createMockPilot(overrides?: Partial<Pilot>): Pilot` - Erstellt einzelnen Piloten
- [ ] AC3: `createMockPilots(count: number): Pilot[]` - Erstellt Array mit `count` Piloten
- [ ] AC4: Piloten haben sinnvolle Defaults: ID, Name, ImageUrl
- [ ] AC5: Mindestens 4 Testdateien mit eigener Mock-Pilot-Logik verwenden die zentrale Factory
- [ ] AC6: Alle Tests laufen weiterhin erfolgreich

## Technische Details

### Betroffene Dateien
- Neue Datei: `tests/helpers/mock-factories.ts`
- Update: `tests/helpers/index.ts`
- Migration: 4+ Testdateien

### Aktuelle Duplikationen

```typescript
// bracket-progression.test.ts
function createMockPilots(count: number) {
  return Array.from({ length: count }, (_, i) => ({
    id: `pilot-${i + 1}`,
    name: `Pilot ${i + 1}`,
    imageUrl: `https://example.com/pilot${i + 1}.jpg`,
  }))
}

// heat-assignment.test.ts
const createTestPilots = (count: number) => {
  const pilots: Array<{ name: string; imageUrl: string }> = []
  for (let i = 0; i < count; i++) {
    pilots.push({
      name: `Pilot ${i + 1}`,
      imageUrl: `https://example.com/pilot${i + 1}.jpg`,
    })
  }
  return pilots
}

// pilot-card.test.tsx - inline
const mockPilot: Pilot = {
  id: '1',
  name: 'Test Pilot',
  imageUrl: 'https://example.com/pilot.jpg',
}
```

### tests/helpers/mock-factories.ts

```typescript
import type { Pilot } from '../../src/lib/schemas';

let pilotCounter = 0;

/**
 * Creates a single mock pilot with sensible defaults.
 * All properties can be overridden.
 * 
 * @param overrides - Partial pilot object to override defaults
 * @returns A complete Pilot object
 * 
 * @example
 * const pilot = createMockPilot();
 * const namedPilot = createMockPilot({ name: 'Max Verstappen' });
 */
export function createMockPilot(overrides?: Partial<Pilot>): Pilot {
  pilotCounter++;
  return {
    id: `test-pilot-${pilotCounter}`,
    name: `Test Pilot ${pilotCounter}`,
    imageUrl: `https://example.com/pilot${pilotCounter}.jpg`,
    instagramHandle: undefined,
    status: 'active',
    droppedOut: false,
    ...overrides,
  };
}

/**
 * Creates an array of mock pilots.
 * 
 * @param count - Number of pilots to create
 * @param overridesOrFactory - Either partial overrides for all pilots,
 *                             or a factory function (index) => Partial<Pilot>
 * @returns Array of Pilot objects
 * 
 * @example
 * const pilots = createMockPilots(4);
 * const customPilots = createMockPilots(4, { status: 'eliminated' });
 * const indexedPilots = createMockPilots(4, (i) => ({ name: `Racer ${i}` }));
 */
export function createMockPilots(
  count: number,
  overridesOrFactory?: Partial<Pilot> | ((index: number) => Partial<Pilot>)
): Pilot[] {
  return Array.from({ length: count }, (_, index) => {
    const overrides = typeof overridesOrFactory === 'function'
      ? overridesOrFactory(index)
      : overridesOrFactory;
    return createMockPilot(overrides);
  });
}

/**
 * Resets the pilot counter.
 * Call this in beforeEach if you need predictable IDs.
 */
export function resetMockPilotCounter(): void {
  pilotCounter = 0;
}

/**
 * Creates mock pilot input (for addPilot action).
 * Does NOT include id, as that's generated by the store.
 */
export function createMockPilotInput(overrides?: Partial<Omit<Pilot, 'id'>>) {
  pilotCounter++;
  return {
    name: `Test Pilot ${pilotCounter}`,
    imageUrl: `https://example.com/pilot${pilotCounter}.jpg`,
    instagramHandle: undefined,
    ...overrides,
  };
}

/**
 * Creates mock pilot inputs for store.addPilot().
 */
export function createMockPilotInputs(count: number) {
  return Array.from({ length: count }, () => createMockPilotInput());
}
```

### tests/helpers/mock-heats.ts (Optional)

```typescript
import type { Heat } from '../../src/types';

let heatCounter = 0;

export function createMockHeat(overrides?: Partial<Heat>): Heat {
  heatCounter++;
  return {
    id: `test-heat-${heatCounter}`,
    heatNumber: heatCounter,
    pilotIds: [],
    status: 'pending',
    bracketType: 'qualification',
    ...overrides,
  };
}

export function resetMockHeatCounter(): void {
  heatCounter = 0;
}
```

### tests/helpers/index.ts (Update)

```typescript
export {
  resetTournamentStore,
  getStoreState,
  setupTournamentWithPilots,
  setupRunningTournament,
} from './store-helpers';

export {
  createMockPilot,
  createMockPilots,
  createMockPilotInput,
  createMockPilotInputs,
  resetMockPilotCounter,
} from './mock-factories';
```

### Migration einer Testdatei

**Vorher (bracket-progression.test.ts):**
```typescript
function createMockPilots(count: number) {
  return Array.from({ length: count }, (_, i) => ({
    id: `pilot-${i + 1}`,
    name: `Pilot ${i + 1}`,
    imageUrl: `https://example.com/pilot${i + 1}.jpg`,
  }))
}
```

**Nachher:**
```typescript
import { createMockPilots, resetMockPilotCounter } from './helpers';

beforeEach(() => {
  resetMockPilotCounter();
});

// In Tests:
const pilots = createMockPilots(12);
```

## Testplan

1. `npm test` - alle Tests müssen grün bleiben
2. Prüfe dass keine lokalen `createMockPilot(s)` mehr existieren:
   ```bash
   grep -r "function createMockPilot" tests/
   grep -r "const createTestPilots" tests/
   ```
